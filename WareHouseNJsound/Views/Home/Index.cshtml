@{
    ViewData["Title"] = "Home Page";
}

@model IEnumerable<WareHouseNJsound.Models.Materials>
@using System.Text.Json

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/boxicons@2.1.4/dist/boxicons.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Domine:wght@598&family=Noto+Sans+Thai:wght@100..900&display=swap" rel="stylesheet" />

    <style>
        table {
            border-collapse: collapse;
            width: 100%;
        }

        table, th, td {
            border: 1px solid #ddd;
        }

        th, td {
            padding: 8px;
            text-align: center;
            vertical-align: middle;
            background-color: #111111;
            color: white;
        }

        th {
            background-color: #E6E6E6;
            color: black;
            font-family: sans-serif;
        }

        .highlight {
            background-color: yellow;
            color: black;
            font-weight: bold;
        }

        body {
            font-family: sans-serif !important;
        }

    </style>
</head>

<body>
    <h1 style="font-family: 'Noto Sans Thai', sans-serif;">รายการอะไหล่ทั้งหมด</h1>
    <h3 style="font-family: 'Noto Sans Thai', sans-serif;">All Materials</h3>

    @{
        var categories = ViewBag.Categories as List<string> ?? new List<string>();
        string selectedCategory = ViewBag.SelectedCategory ?? "all";
    }

    <div class="mb-3 d-flex justify-content-between align-items-center" style="margin-bottom: 20px;">
        <a asp-controller="Home" asp-action="AddMaterial" class="btn btn-success" style="font-family: 'Noto Sans Thai', sans-serif;">
            <i class="bx bx-plus"></i> เพิ่มสินค้า
        </a>

        <div>
            <input type="text" id="searchInput" class="form-control" placeholder="Search..." style="width: 300px;" />
        </div>
    </div>

    <table class="table" style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr>
                <th>No.</th>
                <th>Materials ID</th>
                <th>Picture</th>
                <th>Name</th>
                <th>Category</th>
                <th>Unit</th>
                <th>Stock</th>
                <th>MinimumStock</th>
                <th>Remark</th>
                
            </tr>
        </thead>
        <tbody>
            @{
                int index = 1;
            }
            @foreach (var item in Model)
            {
                <tr>
                    <td>@index</td>
                    <td>@item.Materials_ID</td>
                    <td>
                        @if (item.Picture != null && item.Picture.Length > 0)
                        {
                            var base64 = Convert.ToBase64String(item.Picture);
                            var imgSrc = $"data:image/jpeg;base64,{base64}";
                            <img src="@(imgSrc)" alt="@item.MaterialsName" style="max-width:80px; max-height:60px;" />
                        }
                        else
                        {
                            <span>ไม่มีรูป</span>
                        }
                    </td>
                    <td style="text-align: left;">@item.MaterialsName</td>
                    <td>@item.Category.CategoryName</td>
                    <td>@item.Unit.UnitName</td>
                    <td>@(item.Stock?.OnHandStock ?? 0)</td>
                    <td>@item.MinimumStock</td>
                    <td>@item.Description</td>
                    <td>
                        <a asp-action="Edit" asp-route-id="@item.Materials_ID" title="แก้ไข" class="text-warning" style="margin-right: 10px;">
                            <i class='bx bx-edit-alt' style="font-size: 20px;"></i>
                        </a>
                    </td>
                    <td>
                        <a href="javascript:void(0);" onclick="confirmDelete('@item.Materials_ID')" title="ลบ" class="text-danger" style="margin-right: 10px;">
                            <i class='bx bx-trash' style="font-size: 20px;"></i>
                        </a>
                    </td>
                </tr>
                index++;
            }
        </tbody>
    </table>

    <script>
        $(document).ready(function () {
            // กรองตามหมวดหมู่ (เมื่อเลือกเปลี่ยน dropdown)
            $('#categoryFilter').on('change', function () {
                var selectedCategory = $(this).val();
                var url = '@Url.Action("All_Items", "Management")';
                if (selectedCategory === 'all') {
                    window.location.href = url;
                } else {
                    window.location.href = url + '?category=' + selectedCategory;
                }
            });

            // ฟังก์ชันค้นหาและไฮไลต์คำค้นหา
            function highlight(text) {
                if (!text) return;
                $("table tbody tr").each(function () {
                    $(this).find("td").each(function () {
                        if ($(this).find("img").length > 0) return;

                        var originalHtml = $(this).html();
                        var regex = new RegExp(`(${text})`, "gi");
                        var newHtml = originalHtml.replace(regex, '<span class="highlight">$1</span>');
                        $(this).html(newHtml);
                    });
                });
            }

            function resetHighlight() {
                $("table tbody tr").each(function () {
                    $(this).find("td").each(function () {
                        if ($(this).find("img").length > 0) return;

                        var temp = $('<div>').html($(this).html());
                        temp.find("span.highlight").each(function () {
                            $(this).replaceWith($(this).text());
                        });
                        $(this).html(temp.html());
                    });
                });
            }

            $("#searchInput").on("keyup", function () {
                var value = $(this).val().toLowerCase();
                resetHighlight();
                $("table tbody tr").filter(function () {
                    var match = $(this).text().toLowerCase().indexOf(value) > -1;
                    $(this).toggle(match);
                    return match;
                });
                highlight(value);
            });

            // SweetAlert แสดงข้อความจาก TempData
            var message = @Html.Raw(TempData["SuccessMessage"] != null
                ? JsonSerializer.Serialize(TempData["SuccessMessage"])
                : "null");

            if (message) {
                Swal.fire({
                    icon: 'success',
                    title: 'สำเร็จ',
                    text: message,
                    confirmButtonText: 'ตกลง'
                });
            }
        });  

        function confirmDelete(id) {
            Swal.fire({
                title: 'คุณแน่ใจหรือไม่?',
                text: "คุณจะไม่สามารถย้อนกลับได้!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'ลบ',
                cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = '/Home/Delete/' + id;
                }
            });
        }

    </script>

</body>
</html>
